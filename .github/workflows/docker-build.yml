name: Build and Push to ECR

on:
  push:
    branches:
      - main
#  release:
#    types: [published]

concurrency:
  group: docker-build-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Build, Push Docker & Upload Artifacts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.5"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::417107812602:role/care-activation-dev-ecr-rw-role
          role-session-name: gh-${{ github.repository_id }}-docker-build-${{ github.actor }}
          aws-region: us-west-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

#      - name: Set Image Tags
#        run: |
#          export REPO_URI=${{ steps.login-ecr.outputs.registry }}/care-activation
#          export COMMIT_TAG=sha-${GITHUB_SHA::8}
#          export LATEST_TAG=latest
#          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
#            export VERSION_TAG=${GITHUB_REF#refs/tags/}
#          fi
#          echo "REPO_URI=$REPO_URI" >> $GITHUB_ENV
#          echo "COMMIT_TAG=$COMMIT_TAG" >> $GITHUB_ENV
#          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
#          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
#
#      - name: Build Docker Image (with cache)
#        run: |
#          docker build \
#            --tag $REPO_URI:$COMMIT_TAG \
#            --build-arg DD_GIT_REPOSITORY_URL=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} \
#            --build-arg DD_GIT_COMMIT_SHA=${GITHUB_SHA} \
#            --cache-from $REPO_URI:latest \
#            .
#
#      - name: Push Docker Image
#        run: |
#          docker push $REPO_URI:$COMMIT_TAG
#          docker tag $REPO_URI:$COMMIT_TAG $REPO_URI:$LATEST_TAG
#          docker push $REPO_URI:$LATEST_TAG
#          if [ ! -z "$VERSION_TAG" ]; then
#            docker tag $REPO_URI:$COMMIT_TAG $REPO_URI:$VERSION_TAG
#            docker push $REPO_URI:$VERSION_TAG
#          fi

      - name: Update AWS ECS Service Container
        id: update-aws-ecs-service-container
        run: ls
        #uses: ./.github/actions/terraform-aws-apply/action.yaml
        #with:
        #  aws-env: "dev"


#      - name: Save Docker image metadata to file
#        run: |
#          mkdir -p ../artifacts
#          echo "IMAGE_SHA=$COMMIT_TAG" > ../artifacts/image-info.txt
#          echo "IMAGE_LATEST=$LATEST_TAG" >> ../artifacts/image-info.txt
#          if [ ! -z "$VERSION_TAG" ]; then
#            echo "IMAGE_VERSION=$VERSION_TAG" >> ../artifacts/image-info.txt
#          fi
#
#      - name: Upload artifacts to S3
#        run: |
#          aws s3 cp ../artifacts/image-info.txt s3://my-build-artifacts/care-activation/${GITHUB_SHA}/image-info.txt \
#            --region us-west-2
#          # Optional: set lifecycle for 90-day retention
#          aws s3api put-object-lock-configuration \
#            --bucket my-build-artifacts \
#            --object-lock-configuration '{
#              "ObjectLockEnabled": "Enabled",
#              "Rule": {
#                "DefaultRetention": {
#                  "Mode": "GOVERNANCE",
#                  "Days": 90
#                }
#              }
#            }'
#
#      - name: Notify Slack
#        if: always()
#        uses: slackapi/slack-github-action@v1.26.0
#        with:
#          channel-id: "#deployments"
#          text: |
#            ${{ github.repository }} - Deployment ${{ job.status }}.
#            Commit: ${{ github.sha }}
#        env:
#          SLACK_BOT_TOKEN: ${{ secrets.SLACK_WEBHOOK_URL }}
