generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum PartnerOrganization {
  ELEVANCEHEALTH
  HUMANA
}

enum CareTaskType {
  DEXA_SCAN
  MAMMOGRAM
}

enum CareTaskStatus {
  CANCELLED
  COMPLETED
  PENDING
  SCHEDULED
}

enum CareTaskEventType {
  PATIENT_ONBOARDING_CALL
}

enum CareTaskEventStatus {
  INITIATED
  SUCCESS
  FAILED
  VOICEMAIL
}

enum CareTaskEventResultType {
  QUESTION
  OTHER
  VERIFICATION
}

enum CallerProvider {
  BLAND_AI
  CARTESIA
  ELEVEN_LABS
  PIPECAT
}

// FHIR: https://www.hl7.org/fhir/datatypes-definitions.html#ContactPoint.system
enum ContactPointSystem {
  PHONE
  FAX
  EMAIL
  PAGER
  URL
  SMS
  OTHER
}

// FHIR: https://www.hl7.org/fhir/valueset-contact-point-use.html
enum ContactPointUse {
  HOME
  WORK
  TEMP
  OLD
  MOBILE
}

// FHIR: https://www.hl7.org/fhir/datatypes.html#ContactPoint
model ContactPoint {
  id        String   @id @default(uuid())
  system    ContactPointSystem
  value     String
  use       ContactPointUse
  rank      Int @default(1) // 1 = highest priority

  patient   Patient  @relation(fields: [patientID], references: [id])
  patientID String
}

// FHIR: https://www.hl7.org/fhir/valueset-name-use.html
enum NameUse {
  USUAL
  OFFICIAL
  TEMP
  NICKNAME
  ANONYMOUS
  OLD
  MAIDEN
}

// FHIR: https://www.hl7.org/fhir/datatypes.html#HumanName
model HumanName {
  id      String   @id @default(uuid())
  use     NameUse @default(USUAL)
  family  String
  given   Json // Ideally this is an array of strings, but mySQL doesn't let you do that directly
  prefix  String?
  suffix  String?

  patient Patient  @relation(fields: [patientID], references: [id])
  patientID String
}

model Patient {
  birthDate           DateTime @db.Date
  createdAt           DateTime @default(now())
  telecom             ContactPoint[]
  name                HumanName[]
  externalID          String @unique
  id                  String   @id @default(uuid())
  metadata            Json
  optedOutChannels    PatientOptOut[]
  partnerOrganization PartnerOrganization
  careTasks           CareTask[]
  timezone            String
  updatedAt           DateTime @updatedAt
}

model PatientOptOut {
  createdAt             DateTime        @default(now())
  id                    String          @id @default(uuid())
  patient               Patient         @relation(fields: [patientID], references: [id])
  patientID             String
  contactPointSystem    ContactPointSystem
}

model CareTask {
  createdAt DateTime        @default(now())
  events    CareTaskEvent[]
  id        String          @id @default(uuid())
  patient   Patient         @relation(fields: [patientID], references: [id])
  patientID String
  status    CareTaskStatus  @default(PENDING)
  type      CareTaskType
  updatedAt DateTime        @updatedAt
  callerProvider CallerProvider @default(BLAND_AI)
}

model CareTaskEvent {
  createdAt     DateTime        @default(now())
  type          CareTaskEventType
  externalID    String?
  failureReason String?
  id            String          @id @default(uuid())
  results       CareTaskEventResult[]
  status        CareTaskEventStatus
  careTask      CareTask        @relation(fields: [careTaskID], references: [id])
  careTaskID    String
  updatedAt     DateTime        @updatedAt
}

model CareTaskEventResult {
  createdAt DateTime        @default(now())
  id        String          @id @default(uuid())
  type      CareTaskEventResultType
  eventID   String
  event     CareTaskEvent @relation(fields: [eventID], references: [id])
  key       String
  value     String
  updatedAt DateTime        @updatedAt
  metadata  Json @default("{}")
}
